<%
    kln_string = '';
    get_kln_obj = ArrayOptFirstElem(XQuery("for $elem in cc_kln_results where $elem/person_id = " + (Request.QueryString.mode == "home" ? curUserID : (Request.QueryString.HasProperty("object_id") ? Request.QueryString.object_id : "")) + " and $elem/is_closed = true() order by $elem/mark_date descending return $elem"));

    if(get_kln_obj != undefined)
    {
        kln_string = get_kln_obj.id;
    }
%>

<link rel="stylesheet" href="dominos/checkbox_style.css"/>
<style>
    .profile-container {
        color: rgb(89,151,200);
        width: 100%;
    }
    .profile-container td {
        padding-right:33px;
        vertical-align: bottom;
    }
    #profile-photo img {
        /*height:195px;
        width:195px;*/
    }
    .buttons-container {
        padding-top:20px;
    }
    .buttons-container table {
        border-collapse: collapse;
        width:100%;
    }
    .buttons-container td {
        width:33%;
    }
    .buttons-container div {
        background: rgb(89,151,200);
        width:100%;
        height:60px;
        border-radius: 5px;
        text-align: center;
        color:white;
        line-height: 28px;
    }
    .gradient-button {
        text-align:center;
        padding-top:20px;
        padding-bottom: 0px;
        /*border-bottom: 1px black solid;*/
        width:100%;
        line-height:38px;
    }
    .gradient-button div {
        width:100%;
        height:40px;
        background: linear-gradient(to right, #fa530d, #f9b00c, #fa530d);
        border-radius: 5px;
        color:white;
        font-weight:bold;
        font-size:16px;
    }
    .pizza-rocket {
        /*padding-top:15px;*/
        padding-bottom: 20px;
        border-bottom: 2px solid rgb(89,151,200);
    }
    .glasses {
        width:49%;
        position: relative;
        float:left;
        height:315px;
    }
    .flask-titles {
        width:100%;
        text-align:left;
        color:rgb(89,151,200);
        font-size:20px;
        font-weight: bold;
        padding: 20px 0px 20px 0px;
    }
    .flask-imgs {
        position: absolute;
        left:0px;
        bottom:0px;
    }
    .flask-div {
        position: absolute;
        left:0px;
        bottom:0px;
        overflow:hidden;
    }
    .modalDialog {
        position: fixed;
        font-family: Arial, Helvetica, sans-serif;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0,0,0,0.8);
        z-index: 99999;
        -webkit-transition: opacity 400ms ease-in;
        -moz-transition: opacity 400ms ease-in;
        transition: opacity 400ms ease-in;
        display: none;
        pointer-events: none;
    }
    .modalDialog:target {
        display: block;
        pointer-events: auto;
    }

    .modalDialog > div {
        width: 400px;
        position: relative;
        margin: 10% auto;
        padding: 5px 20px 13px 20px;
        border-radius: 10px;
        background: #fff;
    }
    .css-label a {
        text-decoration: underline;
        cursor:pointer;
    }
</style>


<div style="margin-left:50px">
    <div class="profile-container">
        <table style="border-collapse: collapse">
            <tr>
                <td rowspan="7" id="profile-photo" style="text-align:left;vertical-align: bottom;"></td>
                <td id="profile-name"></td>
            </tr>
           <!-- <tr>
                <td id="profile-phone"></td>
            </tr>-->
            <tr>
                <td id="profile-position"></td>
            </tr>
            <tr>
                <td id="profile-subdiv"></td>
            </tr>
            <tr>
                <td id="profile-birthdate"></td>
            </tr>
            <tr>
                <td id="profile-email"></td>
            </tr>
            <tr>
                <td id="profile-hiredate"></td>
            </tr>
        </table>
    </div>
    <!--<div class="buttons-container">
        <table>
            <tr>
                <td style="padding-right:20px">
                    <div id="work-time"></div>
                </td>
                <td style="padding-right:11px;padding-left:11px" id="kln-res">
                </td>
                <td style="padding-left:20px">
                    <a href="view_doc.html?mode=done_tests"><div id="quart-test"></div></a>
                </td>
            </tr>
        </table>
    </div>-->
    <div class="gradient-button">
        <a href="/view_doc.html?mode=my_account"><div>
            Моё обучение
        </div></a>
    </div>
    <div id="learning-container" style="display:none;padding-top:20px">
        <div class="pizza-rocket">
            <table>
                <tr>
                    <td colspan="2" style="font-size:20px;font-weight: bold;color:rgb(89,151,200);padding:0px 0px 15px 0px;text-align: center">Обучение в пиццерии</td>
                </tr>
                <tr>
                    <td style="width:40%">
                        <div style="position:relative">
                            <img src="dominos/rocket_back_2.png" style="width:100%;height:auto">
                            <img src="dominos/rocket_pizza.png" id="flying-pizza" style="position:absolute;height:112px;left:134px;bottom:0px;">
                        </div>
                    </td>
                    <td id="check-blocks" style="vertical-align: top;padding-left:20px;height:500px">
                    </td>
                </tr>
            </table>
        </div>
        <div class="flask-container">
            <div id="flask" class="glasses" style="margin-bottom:20px">
                <div class="flask-titles">Внешнее обучение</div>
                <table style="width:100%">
                    <tr>
                        <td style="width:50%">
                            <img style="width:50%;" class="flask-imgs" src="/dominos/flask_empty.png">
                            <div class="flask-div" style="height:10px;width:50%" id="full-flask">
                                <img style="width:100%;position:absolute;bottom:0px;left:0px" src="/dominos/flask_full.png">
                            </div>
                        </td>
                        <td style="width:50%">
                            <div style="/*float:right*/" id="flask-inputs">
                            </div>
                        </td>
                    </tr>
                </table>
                <div id="show-all-btn" style="display:none;font-size:14px;position:absolute;right:10px;bottom:10px;background:rgb(89,151,200);height:30px;width:120px;text-align:center;color:white;border-radius:5px;float:right"><a style="color:white" href="#openModal"><div style="position:absolute;top:50%;line-height:0em;width:100%;height:100%;cursor:pointer">Показать еще</div></a></div>
            </div>
            <div id="openModal" class="modalDialog">
                <div style="padding-top:15px">
                    <a href="#close" title="Закрыть" class="close"><img style="position:absolute;top:20px;right:20px" src="/dominos/close.png"></a>
                    <p style="color:rgb(89,151,200);font-size:20px;font-weight: bold">Внешнее обучение</p>
                    <div id="fullshit" style="padding-top:10px">
                    </div>
                </div>
            </div>
            <div id="thermo" class="glasses">
                <div class="flask-titles" style="padding-left:20px">Оценивание</div>
                <table style="width:100%">
                    <tr>
                        <td style="width:50%">
                            <img style="width:30%;padding-left:20px" class="flask-imgs" src="/dominos/thermo_empty.png">
                            <div class="flask-div" style="height:20px;width:30%" id="full-thermo">
                                <img style="width:100%;position:absolute;bottom:0px;left:0px;padding-left:20px" src="/dominos/thermo_full.png">
                            </div>
                        </td>
                        <td style="width:50%">
                            <div style="float:right" id="thermo-inputs">
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div id="instead-image" style="display:none;width:100%;overflow:hidden;padding-top:20px">
    </div>
</div>

<script>
    function draw_profile(input_obj) {
        allowed_to_edit = false;
        
        if(userToGo != '<%=curUserID%>')
        {
            $('.gradient-button').css('display','none')
        }

        if(String(input_obj.users).indexOf('<%=curUserID%>') != -1 || String(userToGo) == String('<%=curUserID%>'))
        {
            allowed_to_edit = true;
        }

        $('#profile-photo').html('<div style="position:relative;overflow:hidden;height:260px;width:260px"><img style="height:100%;" src="' + (input_obj.photo != '' ? input_obj.photo : '/pics/nophoto.jpg') + '">' + (input_obj.position_img != '' ? '<a href="/view_doc.html?mode=common_positions&person_id=' + input_obj.user_id + '"><img style="width:80px;height:auto;position:absolute;left:0px;bottom:0px" src="/download_file.html?file_id=' + input_obj.position_img + '"></a></div>' : ''));
        $('#profile-name').html('<b>ФИО: </b>' + (input_obj.fullname != '' ? input_obj.fullname : '-'));
        $('#profile-phone').html('<b>Телефон: </b>' + (input_obj.phone != '' ? input_obj.phone : '-'));
        $('#profile-position').html('<b>Должность: </b>' + (input_obj.position != '' ? input_obj.position : '-'));
        $('#profile-subdiv').html('<b>Подразделение: </b>' + (input_obj.subdiv != '' ? input_obj.subdiv : '-'));
        $('#profile-birthdate').html('<b>Дата рождения: </b>' + (input_obj.birthdate != '' ? input_obj.birthdate : '-'));
        $('#profile-email').html('<b>E-mail: </b>' + (input_obj.email != '' ? input_obj.email : '-'));
        $('#profile-hiredate').html('<b>Дата приёма на работу: </b>' + (input_obj.hiredate != '' ? input_obj.hiredate : '-') );<!--+ (allowed_to_edit ? '<div style="float:right;margin-left:50px"><a href="/view_doc.html?mode=edit_profile&object_id=' + input_obj.user_id + '"><img src="dominos/edit.png"></a></div>' : '')-->

        workRes = '';
        if(input_obj.worktime_years != 'Нет данных' && input_obj.worktime_months != 'Нет данных')
        {
            workRes += '<a href="/view_doc.html?mode=work_time&object_id=' + input_obj.user_id + '"><div class="work-slider active"><span style="font-size:12px">Время работы в компании<span><br><span style="font-size:16px;font-weight:bold">' + (input_obj.worktime_years != 0 ? (input_obj.worktime_years == 1 ? input_obj.worktime_years + ' год' : (input_obj.worktime_years < 5 ? input_obj.worktime_years + ' года ' : input_obj.worktime_years + ' лет ')) : '') + (input_obj.worktime_months != 0 ? (input_obj.worktime_months == 1 ? input_obj.worktime_months + ' месяц' : (input_obj.worktime_months < 5 ? input_obj.worktime_months + ' месяца' : input_obj.worktime_months + ' месяцев')) : (input_obj.worktime_years != 0 ? '' : '0 месяцев')) + '</span></div></a>';
        }
        else
        {
            workRes += '<a href="/view_doc.html?mode=work_time&object_id=' + input_obj.user_id + '"><div class="work-slider active" style="display:none"><span style="font-size:12px">Время работы в компании<span><br><span style="font-size:16px;font-weight:bold">Нет данных</span></div></a>';
        }

        if(input_obj.work_position_years != 'Нет данных' && input_obj.work_position_months != 'Нет данных')
        {
            workRes += '<a href="/view_doc.html?mode=work_time&object_id=' + input_obj.user_id + '"><div class="work-slider" style="display:none"><span style="font-size:12px">Время на должности<span><br><span style="font-size:16px;font-weight:bold">' + (input_obj.work_position_years != 0 ? (input_obj.work_position_years == 1 ? input_obj.work_position_years + ' год' : (input_obj.work_position_years < 5 ? input_obj.work_position_years + ' года ' : input_obj.work_position_years + ' лет ')) : '') + (input_obj.work_position_months != 0 ? (input_obj.work_position_months == 1 ? input_obj.work_position_months + ' месяц' :(input_obj.work_position_months < 5 ? input_obj.work_position_months + ' месяца' : input_obj.work_position_months + ' месяцев')) : (input_obj.work_position_years != 0 ? '' : '0 месяцев')) + '</span></div></a>';
        }
        else
        {
            workRes += '<a href="/view_doc.html?mode=work_time&object_id=' + input_obj.user_id + '"><div class="work-slider" style="display:none"><span style="font-size:12px">Время на должности<span><br><span style="font-size:16px;font-weight:bold">Нет данных</span></div></a>';
        }

        $('#work-time').html(workRes);

        setInterval(function() {
            $('.work-slider.active').each(function() {
                $(this).css('display','none');
            });
            //setTimeout(function() {
            $('.work-slider').each(function() {
                if($(this).hasClass('active'))
                {
                    $(this).removeClass('active');
                }
                else
                {
                    $(this).addClass('active');
                    //$(this).fadeIn(300);
                    $(this).css('display','block')
                }
            });
            //},300);
            
        },10000);

        if(input_obj.last_test != 'Нет данных')
        {
            $('#quart-test').html('<span style="font-size:12px">Квартальный тест</span><br><span style="font-size:16px;font-weight:bold">' + Number(input_obj.last_test).toFixed(2) + '%</span>'); 
        }
        else
        {
            $('#quart-test').html('<span style="font-size:12px">Квартальный тест</span><br><span style="font-size:16px;font-weight:bold">' + input_obj.last_test + '</span>');  
        }
    }

    function draw_blocks(input_array) {
        progress_blocks = input_array[0].progress_blocks;
        resBlock = '<div style="position:relative;height:100%">';
        checkedNum = 0;
        
        for(b=0;b<progress_blocks.length;b++)
        {
            try
            {
                resBlock += '<input type="checkbox" ' + (progress_blocks[b].progress_mark == "true" ? 'checked ' : '') + 'id="' + progress_blocks[b].progress_check_id + '" class="to-put-blocks css-checkbox"' + (progress_blocks[b].progress_mark == "true" ? ' disabled' : '') + '><label class="css-label" for="' + progress_blocks[b].progress_check_id + '">' + progress_blocks[b].progress_check_name + '</label><br>';

                if(progress_blocks[b].progress_mark == 'true')
                {
                    checkedNum++;
                }
            }
            catch(e)
            {}
        }

        if(allowed_to_edit && userToGo != '<%=curUserID%>')
        {
            resBlock += '<div style="position:absolute;right:60px;bottom:0px;background:rgb(89,151,200);height:40px;width:120px;text-align:center;color:white;border-radius:5px;float:right"><div id="put-blocks" style="position:absolute;top:50%;line-height:0em;width:100%;height:100%;cursor:pointer">Сохранить</div></div><a href="/view_doc.html?mode=education_comments&object_id=' + userToGo + '&diary_id=' + input_array[0].id + '"><img src="dominos/comment.png" style="position:absolute;right:0px;bottom:0px;height:40px;float:right"></a></div>';
        }
        else
        {
            resBlock += '<a href="/view_doc.html?mode=education_comments&object_id=' + userToGo + '&diary_id=' + input_array[0].id + '"><img src="dominos/comment.png" style="position:absolute;right:0px;bottom:0px;height:40px;float:right"></a>';
        }
        

        percentRes = (((checkedNum/progress_blocks.length)*100)*3.85) + 'px';

        $('#flying-pizza').animate({bottom:percentRes},2000);
        $('#check-blocks').html(resBlock);
        $('#learning-container').css("display","block");
        $('#instead-image').css('display','none');

        flask_events = new Array();
        flask_courses = new Array();
        flask_events = input_array[0].common_event_blocks;
        flask_courses = input_array[0].course_blocks;

        flask_all = flask_events.concat(flask_courses);
        flask_all.sort(function(a,b) {return (a.finished < b.finished) ? 1 : ((b.finished < a.finished) ? -1 : 0);} );
        flask_text = '';
        flask_full_text = '';

        if(flask_all.length > 3)
        {
            $('#show-all-btn').css('display','block');
        }

        flask_c_amount = 0;
        for(i=0;i<flask_all.length;i++)
        {
            try
            {
                if(flask_all[i].finished == 'true')
                {
                    flask_c_amount++;
                }
                
                if(flask_all[i].common_event_name != undefined)
                {
                    flask_full_text += '<input class="css-checkbox" type="checkbox"' + (flask_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="' + flask_all[i].common_event_name + '" style="padding-left:35px;padding-top:3px;">' + flask_all[i].common_event_name + '</label><br>';
                }
                else
                {
                    flask_full_text += '<input class="css-checkbox" type="checkbox"' + (flask_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="' + flask_all[i].course_name + '" style="padding-left:35px;padding-top:3px;">' + flask_all[i].course_name + '</label><br>';
                }
            }
            catch(e)
            {}
        }

        for(i=0;i<3;i++)
        {
            try
            {
                if(flask_all[i].common_event_name != undefined)
                {
                    flask_text += '<input class="css-checkbox" type="checkbox"' + (flask_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="' + flask_all[i].common_event_name + '" style="padding-left:35px;padding-bottom:15px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;width:200px">' + flask_all[i].common_event_name + '</label><br>';
                }
                else
                {
                    flask_text += '<input class="css-checkbox" type="checkbox"' + (flask_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="' + flask_all[i].course_name + '" style="padding-left:35px;padding-bottom:15px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;width:200px">' + flask_all[i].course_name + '</label><br>';
                }
            }
            catch(e)
            {}
        }

        percentFlask = (((flask_c_amount/flask_all.length)*100)*2.47) + 'px';

        $('#flask-inputs').html(flask_text);
        $('#fullshit').html(flask_full_text);
        $('#full-flask').animate({height:percentFlask},2000);

        if(flask_c_amount == flask_all.length && checkedNum == progress_blocks.length)
        {
            thermo_tests = new Array();
            thermo_klns = new Array();
            thermo_polls = new Array();
            thermo_tests = input_array[0].assessment_blocks;
            thermo_klns = input_array[0].kln_blocks;
            thermo_polls = input_array[0].poll_blocks;

            thermo_all = (thermo_tests.concat(thermo_klns)).concat(thermo_polls);
            thermo_all.sort(function(a,b) {return (a.finished < b.finished) ? 1 : ((b.finished < a.finished) ? -1 : 0);} );
            thermo_text = '';

            thermo_c_amount = 0;
            for(i=0;i<thermo_all.length;i++)
            {
                try
                {
                    if(thermo_all[i].finished == 'true')
                    {
                        thermo_c_amount++;
                    }
                }
                catch(e)
                {}
            }

            for(i=0;i<thermo_all.length;i++)
            {
                try
                {
                    if(thermo_all[i].assessment_name != undefined)
                    {
                        thermo_text += '<input class="css-checkbox" type="checkbox"' + (thermo_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="' + thermo_all[i].assessment_name + '" style="padding-left:35px;padding-bottom:15px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;width:215px">' + thermo_all[i].assessment_name + '</label><br>';
                    }
                    else if(thermo_all[i].kln_name != undefined)
                    {
                        if(allowed_to_edit)
                        {
                            thermo_text += '<input class="css-checkbox" type="checkbox"' + (thermo_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="' + thermo_all[i].kln_name + '" style="padding-left:35px;padding-bottom:15px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;width:215px"><a href="/view_doc.html?mode=fill_kln&object_id=' + thermo_all[i].kln_id + '">' + thermo_all[i].kln_name + '</a></label><br>';
                        }
                        else
                        {
                            thermo_text += '<input class="css-checkbox" type="checkbox"' + (thermo_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="' + thermo_all[i].kln_name + '" style="padding-left:35px;padding-bottom:15px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;width:215px">' + thermo_all[i].kln_name + '</label><br>';
                        }
                    }
                    else
                    {
                        if(allowed_to_edit || String(input_array[0].allowed_to_comment).indexOf('<%=curUserID%>') != -1)
                        {
                            thermo_text += '<input class="css-checkbox" type="checkbox"' + (thermo_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="Комментарии" style="padding-left:35px;padding-bottom:15px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;width:215px"><a href="/view_doc.html?mode=grade_comments&object_id=' + input_array[0].id + '">Комментарии</a></label><br>';
                        }
                        else
                        {
                            thermo_text += '<input class="css-checkbox" type="checkbox"' + (thermo_all[i].finished == 'true' ? ' checked' : '') + ' disabled><label class="css-label" title="Комментарии" style="padding-left:35px;padding-bottom:15px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;width:215px">Комментарии</label><br>';
                        }
                    }
                }
                catch(e)
                {}
            }

            percentThermo = (((thermo_c_amount/thermo_all.length)*100)*2.48) + 'px';

            $('#thermo-inputs').html(thermo_text);
            $('#full-thermo').animate({height:percentThermo},2000);
        }
        else
        {
            $('#thermo').css('display','none')
        }
    }

    var userToGo = '<%=(Request.QueryString.mode == "home" ? curUserID : (Request.QueryString.HasProperty("object_id") ? Request.QueryString.object_id : ""))%>';

    $.ajax({
            url: 'custom_web_template.html?object_id=6389511220497639771&action=get_person_info',
            type: 'POST',
            cache: false,
            data: 'param={"person_id":"' + userToGo + '"}',
            dataType: 'html', //'application/json', 
            async: false,
            success: function (response)
            {
                //console.log(response);
                personResponse = JSON.parse(response);
                //console.log(personResponse);
                draw_profile(personResponse);
            },
            error: function(oXttpRequest, sTextStatus, sErrorThrown)
            {
                alert('Error: ' + sTextStatus );
            }
        });

    $.ajax({
            url: 'custom_web_template.html?object_id=6389511220497639922&action=get_kln_mark',
            type: 'POST',
            cache: false,
            data: 'param={"kln_id":"<%=kln_string%>"}',
            dataType: 'html', //'application/json', 
            async: false,
            success: function (response)
            {
                //console.log('KLN:' + response);
                //personResponse = JSON.parse(response);
                //console.log(personResponse);
                if(response != '')
                {
                    if(allowed_to_edit)
                    {
                        $('#kln-res').html('<a href="/view_doc.html?mode=kln_list&object_id=' + userToGo + '"><div><span style="font-size:12px">КЛН</span><br><span style="font-size:16px;font-weight:bold">' + Number(response).toFixed(2) + '%</span></div></a>');
                    }
                    else
                    {
                        $('#kln-res').html('<div><span style="font-size:12px">КЛН</span><br><span style="font-size:16px;font-weight:bold">' + Number(response).toFixed(2) + '%</span></div>');
                    }
                }
                else
                {
                    if(allowed_to_edit)
                    {
                        $('#kln-res').html('<a href="/view_doc.html?mode=kln_list&object_id=' + userToGo + '"><div><span style="font-size:12px">КЛН</span><br><span style="font-size:16px;font-weight:bold">Нет данных</span></div></a>');
                    }
                    else
                    {
                        $('#kln-res').html('<div><span style="font-size:12px">КЛН</span><br><span style="font-size:16px;font-weight:bold">Нет данных</span></div>');
                    }
                }
            },
            error: function(oXttpRequest, sTextStatus, sErrorThrown)
            {
                alert('Error: ' + sTextStatus );
            }
        });

    if(personResponse.show_learning == 'true')
    {
        $.ajax({
                url: 'custom_web_template.html?object_id=6389511220497639933&action=get_position_progress',
                type: 'POST',
                cache: false,
                data: 'param={"person_id":"' + userToGo + '"}',
                dataType: 'html', //'application/json', 
                async: false,
                success: function (response)
                {
                    //console.log(response);
                    blocksResponse = JSON.parse(response);
                    //console.log(blocksResponse);
                    draw_blocks(blocksResponse)
                },
                error: function(oXttpRequest, sTextStatus, sErrorThrown)
                {
                    alert('Error: ' + sTextStatus );
                }
            });
    }
    else
    {
        $('#instead-image').css('display','block');
        $('#learning-container').css('display','none');

        if(personResponse.prof_img_id != '')
        {
            $('#instead-image').html('<img style="width:100%" src="/download_file.html?file_id=' + personResponse.prof_img_id + '">');
        }
    }

    $('#put-blocks').click(function() {
        putBlocksArray = '[';
        all_blocks = $('.to-put-blocks');
        new_marked = 0;

        for(i=0;i<all_blocks.length;i++)
        {
            try
            {
                if(i == (all_blocks.length-1))
                {
                    putBlocksArray += '{"block_id":"' + $(all_blocks[i]).prop('id') + '","is_marked":"' + $(all_blocks[i]).prop('checked') + '"}';
                }
                else
                {
                    putBlocksArray += '{"block_id":"' + $(all_blocks[i]).prop('id') + '","is_marked":"' + $(all_blocks[i]).prop('checked') + '"},';
                }

                if($(all_blocks[i]).prop('checked') == true)
                {
                    new_marked++;
                }
            }
            catch(e)
            {
                alert(e);
            }
        }

        putBlocksArray += ']';
        newPercentRes = (((new_marked/all_blocks.length)*100)*3.85) + 'px';

        $.ajax({
            url: 'custom_web_template.html?object_id=6389511220497639933&action=put_position_progress',
            type: 'POST',
            cache: false,
            data: 'param={"person_id":"' + userToGo + '","doc_id":"' + blocksResponse[0].id + '","blocks_array":' + putBlocksArray + '}',
            dataType: 'html', //'application/json', 
            async: false,
            success: function (response)
            {
                //console.log(response)
                if(response == 'true')
                {
                    //console.log('tut')
                    $('#flying-pizza').animate({bottom:newPercentRes},2000);

                    for(i=0;i<all_blocks.length;i++)
                    {
                        try
                        {
                            if($(all_blocks[i]).prop('checked') == true)
                            {
                                $(all_blocks[i]).prop('disabled','true');
                            }
                        }
                        catch(e)
                        {
                            alert(e);
                        }
                    }
                }
            },
            error: function(oXttpRequest, sTextStatus, sErrorThrown)
            {
                alert('Error: ' + sTextStatus );
            }
        });
    });
</script>

<script> 

		// количество снежинок, которое будет на экране одновременно.
		var snowmax=20
		 
		// Цвета для снежинок. Для каждой конкретной снежинки цвет выбирается случайно из этого массива.
		var snowcolor=new Array("#b9dff5","#7fc7ff","#7fb1ff","#7fc7ff","#b9dff5")
		 
		// Шрифт для снежинок
		var snowtype=new Array("Times")
		 
		// Символ (*) и есть снежинка, в место нее можно вставить любой другой символ.
		var snowletter="&#10052;"
		 
		// Скорость движения снежинок (от 0.3 до 2)
		var sinkspeed=0.4
		 
		// Максимальный размер для снежинок
		var snowmaxsize=40
		 
		// Минимальный размер для снежинок
		var snowminsize=10
		 
		// Зона для снежинок
		// 1 для всей страницы, 2 в левой части страницы
		// 3 в центральной части, 4 в правой части страницы
		var snowingzone=1
		 
		////////////////////////
		///////// Конец настроек
		////////////////////////
		 
		var snow=new Array()
		var marginbottom
		var marginright
		var timer
		var i_snow=0
		var x_mv=new Array();
		var crds=new Array();
		var lftrght=new Array();
		var browserinfos=navigator.userAgent
		var ie5=document.all&&document.getElementById&&!browserinfos.match(/Opera/)
		var ns6=document.getElementById&&!document.all
		var opera=browserinfos.match(/Opera/)
		var browserok=ie5||ns6||opera
		 
		function randommaker(range) {
		    rand=Math.floor(range*Math.random())
		    return rand
		}
		 
		function initsnow() {
		    if (ie5 || opera) {
			marginbottom = document.documentElement.clientHeight+10
			marginright = document.body.clientWidth-15
		    }
		    else if (ns6) {
			marginbottom = document.documentElement.clientHeight+10
			marginright = window.innerWidth-15
		    }
		    var snowsizerange=snowmaxsize-snowminsize
		    for (i=0;i<=snowmax;i++) {
			crds[i] = 0;
			lftrght[i] = Math.random()*15;
			x_mv[i] = 0.03 + Math.random()/10;
			snow[i]=document.getElementById("s"+i)
			snow[i].style.fontFamily=snowtype[randommaker(snowtype.length)]
			snow[i].size=randommaker(snowsizerange)+snowminsize
			snow[i].style.fontSize=snow[i].size+'px';
			snow[i].style.color=snowcolor[randommaker(snowcolor.length)]
			snow[i].style.zIndex=1000
			snow[i].sink=sinkspeed*snow[i].size/5
			if (snowingzone==1) {snow[i].posx=randommaker(marginright-snow[i].size)}
			if (snowingzone==2) {snow[i].posx=randommaker(marginright/2-snow[i].size)}
			if (snowingzone==3) {snow[i].posx=randommaker(marginright/2-snow[i].size)+marginright/4}
			if (snowingzone==4) {snow[i].posx=randommaker(marginright/2-snow[i].size)+marginright/2}
			snow[i].posy=randommaker(2*marginbottom-marginbottom-2*snow[i].size)
			snow[i].style.left=snow[i].posx+'px';
			snow[i].style.top=snow[i].posy+'px';
		    }
		    movesnow()
		}
		 
		function movesnow() {
		    for (i=0;i<=snowmax;i++) {
			crds[i] += x_mv[i];
			snow[i].posy+=snow[i].sink
			snow[i].style.left=snow[i].posx+lftrght[i]*Math.sin(crds[i])+'px';
			snow[i].style.top=snow[i].posy+'px';
			
			if (snow[i].posy>=marginbottom-2*snow[i].size || parseInt(snow[i].style.left)>(marginright-3*lftrght[i])){
			    if (snowingzone==1) {snow[i].posx=randommaker(marginright-snow[i].size)}
			    if (snowingzone==2) {snow[i].posx=randommaker(marginright/2-snow[i].size)}
			    if (snowingzone==3) {snow[i].posx=randommaker(marginright/2-snow[i].size)+marginright/4}
			    if (snowingzone==4) {snow[i].posx=randommaker(marginright/2-snow[i].size)+marginright/2}
			    snow[i].posy=0
			}
		    }
		    var timer=setTimeout("movesnow()",50)
		}
		 
		for (i=0;i<=snowmax;i++) {
		    document.body.insertAdjacentHTML('beforeend', "<span id='s"+i+"' style='user-select:none;position:absolute;top:-"+snowmaxsize+"'>"+snowletter+"</span>")
		}
		 
		if (browserok) {
		    window.onload=initsnow    
		}

</script>